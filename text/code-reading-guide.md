# Razor Indent Formatter: 初心者向けコードリーディングガイド

このドキュメントは、TypeScript が初めてでも追いやすいように、
「どこから読めば全体像がつかめるか」を短い順序で案内します。

## 1. まずは全体像（30秒）
- 入力された Razor/HTML/JS を **行頭インデントだけ** 整形するツールです。
- 改行数と行内容（行頭以外）は基本的に変えない方針です。
  - 例外: switch/case の可読性向上のため、case 間の空行を挿入します。
  - Razor text 行（`@:`）の場合は空行を `@:` 行として挿入します。
- UI は `src/main.ts`、整形ロジックは `src/formatter.ts` に集約されています。

## 2. 動かし方（確認用）
```bash
pnpm install
pnpm dev
```

## 3. ファイル地図（どこに何がある？）
- `src/main.ts` UI とイベント処理（入力→整形→出力）
- `src/formatter.ts` インデント整形の本体
- `src/style.css` 画面の見た目
- `scripts/test-format.ts` 整形ロジックの簡易テスト
- `scripts/verify-single.mjs` 単一 HTML ビルド検証

## 4. 読む順番（迷ったらこれ）
1. `src/main.ts`：入力がどの関数に渡るかを確認
2. `src/formatter.ts`：`formatText` の全体フローを把握
3. `src/formatter.ts`：補助関数（タグ抽出・ブレース数えなど）
4. `scripts/test-format.ts`：仕様や期待値をテストから理解

## 5. UI 側（src/main.ts）
ここは「画面」と「整形ロジック」の橋渡しです。

- `formatAndDisplay()` で `formatText()` を呼び出し、結果を Output に反映
- `indentSize` は現在 4 固定
- Input/Output のスクロール同期や横スクロール設定は UI 側
- ドラッグ&ドロップ読み込み時に **UTF-8 / Shift-JIS / EUC-JP** の判定を行い、文字化けを避ける

ポイント: **UI は薄い**。整形の正体は `formatter.ts` に集中しています。

## 6. 整形の本体（src/formatter.ts）
### 6.1 入口
- `formatText(input, options)` が唯一の公開関数
- `FormatOptions` は `indentSize` と `adjustTextBlocks`

### 6.2 大きな流れ（ざっくり）
1. 入力を行に分割
2. 各行の先頭空白と本文を解析
3. HTML タグや `{}` の開閉数を数えて **インデントレベル** を決定
4. `<text>`, `<script>`, `<style>` など特殊ブロックを処理
5. 行頭だけ置き換えた結果を組み立て
6. switch/case の可読性向上で **case 間に空行を挿入**
7. **行内容が変わっていないことを検証**

### 6.3 なぜ「パーサー」を使っていないの？
- HTML/Razor/JS が混ざったとき、厳密なパーサーは壊れやすい
- ここでは「安全にインデントだけ直す」ことを重視
- だから **正規表現 + カウント方式** で控えめに判断しています

## 7. インデント計算の考え方
### 7.1 インデント幅
- スペースは 1
- タブは `indentSize` 扱い

### 7.2 HTML タグの扱い
- `<div>` などを「開き」としてカウント
- `</div>` などを「閉じ」としてカウント
- `<img />` や `<br>` は自己閉じとしてレベルに影響しない

### 7.3 `{}` ブレースの扱い
- Razor/JS の `{` と `}` を数える
- ただし、文字列やコメントの中は無視する

### 7.4 特殊ブロック
- `<text>` は Razor 特有のテキストブロック
- `<script>` / `<style>` は「生コード」扱い
- これらは別のルールでインデントを調整
- Razor text 行（`@:`）は **`@:` の後ろ側だけ** インデントを追加する
  - 内容がある場合は `@:` の直後に **必ず 1 スペース** 入れる
- `<script>` / `<style>` 内で **Razor ディレクティブと通常コードが混在**している場合は安全のため変更しない

## 8. 安全装置（失敗しないための仕組み）
- `validateOutput()` で **行頭以外が変わっていないか** を検証
- もし変わっていたら、整形結果は捨てて元を返す
  - switch/case の空行挿入のみ例外として許可
  - Razor text の空行は `@:` 行を挿入する

## 9. テストを見ると仕様がわかる
`scripts/test-format.ts` は実質的な仕様書です。
- 行数が変わらない
- 行頭以外が変わらない
- `<text>` ブロックが冪等（何回整形しても変わらない）
- switch/case のインデントと空行挿入が期待通りになる
- Razor text 行内の switch/case も整形対象

## 10. よくある改造ポイント
- **インデント幅を可変にする**
  - `src/main.ts` の `indentSize` を UI から入力させる
- **タグや特殊ブロックを増やす**
  - `VOID_TAGS` や `RAW_TAGS` に追加
- **より厳密な解析**
  - `extractTags()` や `countBraces()` を拡張
- **文字コード判定を増やす**
  - `detectEncoding()` に候補を追加し、妥当性チェック関数を増やす

---

このガイドは「最短で全体が分かる」ことを目標にしています。
分からない箇所が出たら、具体的にその関数名を教えてください。
そこだけ噛み砕いて解説します。
